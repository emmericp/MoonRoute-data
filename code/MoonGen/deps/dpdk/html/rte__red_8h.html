<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>DPDK: lib/librte_sched/rte_red.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_fcaecf9e47d3074427ceb27ca105ed74.html">lib</a></li><li class="navelem"><a class="el" href="dir_c7c066db16bc3b8df80f3b368dc7c9c3.html">librte_sched</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">rte_red.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;limits.h&gt;</code><br />
<code>#include &lt;<a class="el" href="rte__common_8h.html">rte_common.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="rte__debug_8h.html">rte_debug.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrte__red__params.html">rte_red_params</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrte__red__config.html">rte_red_config</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrte__red.html">rte_red</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ac7f40ab4c0f8f5f4c2c5fc616e34b3da"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#ac7f40ab4c0f8f5f4c2c5fc616e34b3da">RTE_RED_SCALING</a>&#160;&#160;&#160;10</td></tr>
<tr class="separator:ac7f40ab4c0f8f5f4c2c5fc616e34b3da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8ac9784c83db698f346e22064fe83729"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a8ac9784c83db698f346e22064fe83729">RTE_RED_S</a>&#160;&#160;&#160;(1 &lt;&lt; 22)</td></tr>
<tr class="separator:a8ac9784c83db698f346e22064fe83729"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3afa79600af4b97c54da9072130ae8e3"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a3afa79600af4b97c54da9072130ae8e3">RTE_RED_MAX_TH_MAX</a>&#160;&#160;&#160;1023</td></tr>
<tr class="separator:a3afa79600af4b97c54da9072130ae8e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a512728b7ee03916ce90c1af8fe032129"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a512728b7ee03916ce90c1af8fe032129">RTE_RED_WQ_LOG2_MIN</a>&#160;&#160;&#160;1</td></tr>
<tr class="separator:a512728b7ee03916ce90c1af8fe032129"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a30e1ecf796f99498b7979a195d8837c4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a30e1ecf796f99498b7979a195d8837c4">RTE_RED_WQ_LOG2_MAX</a>&#160;&#160;&#160;12</td></tr>
<tr class="separator:a30e1ecf796f99498b7979a195d8837c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adb5b8e21957f928b888b90a227cbaf37"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#adb5b8e21957f928b888b90a227cbaf37">RTE_RED_MAXP_INV_MIN</a>&#160;&#160;&#160;1</td></tr>
<tr class="separator:adb5b8e21957f928b888b90a227cbaf37"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad96cf7939dccd33568380b7594da0906"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#ad96cf7939dccd33568380b7594da0906">RTE_RED_MAXP_INV_MAX</a>&#160;&#160;&#160;255</td></tr>
<tr class="separator:ad96cf7939dccd33568380b7594da0906"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8a67843db41df1b5930ad7573e4be1e2"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a8a67843db41df1b5930ad7573e4be1e2">RTE_RED_2POW16</a>&#160;&#160;&#160;(1&lt;&lt;16)</td></tr>
<tr class="separator:a8a67843db41df1b5930ad7573e4be1e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:afcd792387df42bfdf6f73eb13eca9e4a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#afcd792387df42bfdf6f73eb13eca9e4a">rte_red_rt_data_init</a> (struct <a class="el" href="structrte__red.html">rte_red</a> *red)</td></tr>
<tr class="memdesc:afcd792387df42bfdf6f73eb13eca9e4a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialises run-time data.  <a href="#afcd792387df42bfdf6f73eb13eca9e4a">More...</a><br /></td></tr>
<tr class="separator:afcd792387df42bfdf6f73eb13eca9e4a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5aa43ae4a1f78b9d0673df511ed0d9fa"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a5aa43ae4a1f78b9d0673df511ed0d9fa">rte_red_config_init</a> (struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *red_cfg, const uint16_t wq_log2, const uint16_t min_th, const uint16_t max_th, const uint16_t maxp_inv)</td></tr>
<tr class="memdesc:a5aa43ae4a1f78b9d0673df511ed0d9fa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configures a single RED configuration parameter structure.  <a href="#a5aa43ae4a1f78b9d0673df511ed0d9fa">More...</a><br /></td></tr>
<tr class="separator:a5aa43ae4a1f78b9d0673df511ed0d9fa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6e62e4278e63bbd9ca0bf07eb07f8979"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a6e62e4278e63bbd9ca0bf07eb07f8979">rte_fast_rand</a> (void)</td></tr>
<tr class="memdesc:a6e62e4278e63bbd9ca0bf07eb07f8979"><td class="mdescLeft">&#160;</td><td class="mdescRight">Generate random number for RED.  <a href="#a6e62e4278e63bbd9ca0bf07eb07f8979">More...</a><br /></td></tr>
<tr class="separator:a6e62e4278e63bbd9ca0bf07eb07f8979"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a068f9175155eaa2fdb31c8073b530c26"><td class="memItemLeft" align="right" valign="top">static uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a068f9175155eaa2fdb31c8073b530c26">__rte_red_calc_qempty_factor</a> (uint8_t wq_log2, uint16_t m)</td></tr>
<tr class="memdesc:a068f9175155eaa2fdb31c8073b530c26"><td class="mdescLeft">&#160;</td><td class="mdescRight">calculate factor to scale average queue size when queue becomes empty  <a href="#a068f9175155eaa2fdb31c8073b530c26">More...</a><br /></td></tr>
<tr class="separator:a068f9175155eaa2fdb31c8073b530c26"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a634ddc87ef2123f8966e17b83543a6c5"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a634ddc87ef2123f8966e17b83543a6c5">rte_red_enqueue_empty</a> (const struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *red_cfg, struct <a class="el" href="structrte__red.html">rte_red</a> *red, const uint64_t time)</td></tr>
<tr class="memdesc:a634ddc87ef2123f8966e17b83543a6c5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates queue average in condition when queue is empty.  <a href="#a634ddc87ef2123f8966e17b83543a6c5">More...</a><br /></td></tr>
<tr class="separator:a634ddc87ef2123f8966e17b83543a6c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aefd904d7e538ba6fdc54bed3167094f1"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#aefd904d7e538ba6fdc54bed3167094f1">__rte_red_drop</a> (const struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *red_cfg, struct <a class="el" href="structrte__red.html">rte_red</a> *red)</td></tr>
<tr class="memdesc:aefd904d7e538ba6fdc54bed3167094f1"><td class="mdescLeft">&#160;</td><td class="mdescRight">make a decision to drop or enqueue a packet based on mark probability criteria  <a href="#aefd904d7e538ba6fdc54bed3167094f1">More...</a><br /></td></tr>
<tr class="separator:aefd904d7e538ba6fdc54bed3167094f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5ee559dca02450c40e42fbc6701af465"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#a5ee559dca02450c40e42fbc6701af465">rte_red_enqueue_nonempty</a> (const struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *red_cfg, struct <a class="el" href="structrte__red.html">rte_red</a> *red, const unsigned q)</td></tr>
<tr class="memdesc:a5ee559dca02450c40e42fbc6701af465"><td class="mdescLeft">&#160;</td><td class="mdescRight">Decides if new packet should be enqeued or dropped in queue non-empty case.  <a href="#a5ee559dca02450c40e42fbc6701af465">More...</a><br /></td></tr>
<tr class="separator:a5ee559dca02450c40e42fbc6701af465"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abbb99f5911d3bfe64f413563dacafea8"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#abbb99f5911d3bfe64f413563dacafea8">rte_red_enqueue</a> (const struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *red_cfg, struct <a class="el" href="structrte__red.html">rte_red</a> *red, const unsigned q, const uint64_t time)</td></tr>
<tr class="memdesc:abbb99f5911d3bfe64f413563dacafea8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Decides if new packet should be enqeued or dropped Updates run time data based on new queue size value. Based on new queue average and RED configuration parameters gives verdict whether to enqueue or drop the packet.  <a href="#abbb99f5911d3bfe64f413563dacafea8">More...</a><br /></td></tr>
<tr class="separator:abbb99f5911d3bfe64f413563dacafea8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa8f3c8188a9863194fab31001225dd6"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#afa8f3c8188a9863194fab31001225dd6">rte_red_mark_queue_empty</a> (struct <a class="el" href="structrte__red.html">rte_red</a> *red, const uint64_t time)</td></tr>
<tr class="memdesc:afa8f3c8188a9863194fab31001225dd6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback to records time that queue became empty.  <a href="#afa8f3c8188a9863194fab31001225dd6">More...</a><br /></td></tr>
<tr class="separator:afa8f3c8188a9863194fab31001225dd6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ae490ddaf8bbddcff7f39643aee34d40e"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rte__red_8h.html#ae490ddaf8bbddcff7f39643aee34d40e">rte_red_rand_val</a></td></tr>
<tr class="separator:ae490ddaf8bbddcff7f39643aee34d40e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>RTE Random Early Detection (RED) </p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="a8a67843db41df1b5930ad7573e4be1e2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTE_RED_2POW16&#160;&#160;&#160;(1&lt;&lt;16)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>2 power 16 </p>

</div>
</div>
<a class="anchor" id="a3afa79600af4b97c54da9072130ae8e3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTE_RED_MAX_TH_MAX&#160;&#160;&#160;1023</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Max threshold limit in fixed point format </p>

</div>
</div>
<a class="anchor" id="ad96cf7939dccd33568380b7594da0906"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTE_RED_MAXP_INV_MAX&#160;&#160;&#160;255</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Max inverse mark probability value </p>

</div>
</div>
<a class="anchor" id="adb5b8e21957f928b888b90a227cbaf37"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTE_RED_MAXP_INV_MIN&#160;&#160;&#160;1</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Min inverse mark probability value </p>

</div>
</div>
<a class="anchor" id="a8ac9784c83db698f346e22064fe83729"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTE_RED_S&#160;&#160;&#160;(1 &lt;&lt; 22)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Packet size multiplied by number of leaf queues </p>

</div>
</div>
<a class="anchor" id="ac7f40ab4c0f8f5f4c2c5fc616e34b3da"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTE_RED_SCALING&#160;&#160;&#160;10</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Fraction size for fixed-point </p>

</div>
</div>
<a class="anchor" id="a30e1ecf796f99498b7979a195d8837c4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTE_RED_WQ_LOG2_MAX&#160;&#160;&#160;12</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Max inverse filter weight value </p>

</div>
</div>
<a class="anchor" id="a512728b7ee03916ce90c1af8fe032129"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTE_RED_WQ_LOG2_MIN&#160;&#160;&#160;1</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Min inverse filter weight value </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a068f9175155eaa2fdb31c8073b530c26"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint16_t __rte_red_calc_qempty_factor </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>wq_log2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>m</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>calculate factor to scale average queue size when queue becomes empty </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">wq_log2,where</td><td>EWMA filter weight wq = 1/(2 ^ wq_log2) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">m</td><td>exponent in the computed value (1 - wq) ^ m</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>computed value </dd></dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">((1</td><td>- wq) ^ m) scaled in fixed-point format </td></tr>
  </table>
  </dd>
</dl>
<p>Basic math tells us that: a^b = 2^(b * log2(a) )</p>
<p>in our case: a = (1-Wq) b = m Wq = 1/ (2^log2n)</p>
<p>So we are computing this equation: factor = 2 ^ ( m * log2(1-Wq))</p>
<p>First we are computing: n = m * log2(1-Wq)</p>
<p>To avoid dealing with signed numbers log2 values are positive but they should be negative because (1-Wq) is always &lt; 1. Contents of log2 table values are also scaled for precision.</p>
<p>The tricky part is computing 2^n, for this I split n into integer part and fraction part. f - is fraction part of n n - is integer part of original n</p>
<p>Now using basic math we compute 2^n: 2^(f+n) = 2^f * 2^n 2^f - we use lookup table 2^n - can be replaced with bit shift right oeprations</p>

</div>
</div>
<a class="anchor" id="aefd904d7e538ba6fdc54bed3167094f1"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int __rte_red_drop </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *&#160;</td>
          <td class="paramname"><em>red_cfg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structrte__red.html">rte_red</a> *&#160;</td>
          <td class="paramname"><em>red</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>make a decision to drop or enqueue a packet based on mark probability criteria </p>
<p>Drop probability (Sally Floyd and Van Jacobson):</p>
<p>pb = (1 / maxp_inv) * (avg - min_th) / (max_th - min_th) pa = pb / (2 - count * pb)</p>
<pre class="fragment">           (1 / maxp_inv) * (avg - min_th)
          ---------------------------------
                   max_th - min_th
</pre><p> pa = -----------------------------------------&mdash;&mdash; count * (1 / maxp_inv) * (avg - min_th) 2 - -----------------------------------&mdash;&mdash; max_th - min_th</p>
<pre class="fragment">                            avg - min_th
</pre><p> pa = -----------------------------------------------------&mdash;&mdash; 2 * (max_th - min_th) * maxp_inv - count * (avg - min_th)</p>
<p>We define pa_const as: pa_const = 2 * (max_th - min_th) * maxp_inv. Then:</p>
<pre class="fragment">               avg - min_th
</pre><p> pa = -----------------------------&mdash;&mdash; pa_const - count * (avg - min_th) </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">config</td><td>pointer to structure defining RED parameters </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">data</td><td>pointer to RED runtime data</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>operation status </dd></dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>enqueue the packet </td></tr>
    <tr><td class="paramname">1</td><td>drop the packet </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a6e62e4278e63bbd9ca0bf07eb07f8979"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint32_t rte_fast_rand </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Generate random number for RED. </p>
<p>Implemenetation based on: <a href="http://software.intel.com/en-us/articles/fast-random-number-generator-on-the-intel-pentiumr-4-processor/">http://software.intel.com/en-us/articles/fast-random-number-generator-on-the-intel-pentiumr-4-processor/</a></p>
<p>10 bit shift has been found through empirical tests (was 16).</p>
<dl class="section return"><dt>Returns</dt><dd>Random number between 0 and (2^22 - 1) </dd></dl>

</div>
</div>
<a class="anchor" id="a5aa43ae4a1f78b9d0673df511ed0d9fa"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int rte_red_config_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *&#160;</td>
          <td class="paramname"><em>red_cfg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>wq_log2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>min_th</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>max_th</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>maxp_inv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Configures a single RED configuration parameter structure. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">config</td><td>pointer to a RED configuration parameter structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">wq_log2</td><td>log2 of the filter weight, valid range is: RTE_RED_WQ_LOG2_MIN &lt;= wq_log2 &lt;= RTE_RED_WQ_LOG2_MAX </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">min_th</td><td>queue minimum threshold in number of packets </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">max_th</td><td>queue maximum threshold in number of packets </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">maxp_inv</td><td>inverse maximum mark probability</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Operation status </dd></dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>success </td></tr>
    <tr><td class="paramname">!0</td><td>error </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="abbb99f5911d3bfe64f413563dacafea8"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int rte_red_enqueue </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *&#160;</td>
          <td class="paramname"><em>red_cfg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structrte__red.html">rte_red</a> *&#160;</td>
          <td class="paramname"><em>red</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned&#160;</td>
          <td class="paramname"><em>q</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint64_t&#160;</td>
          <td class="paramname"><em>time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Decides if new packet should be enqeued or dropped Updates run time data based on new queue size value. Based on new queue average and RED configuration parameters gives verdict whether to enqueue or drop the packet. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">config</td><td>pointer to a RED configuration parameter structure </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">data</td><td>pointer to RED runtime data </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">q</td><td>updated queue size in packets </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current time stamp</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Operation status </dd></dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>enqueue the packet </td></tr>
    <tr><td class="paramname">1</td><td>drop the packet based on max threshold criteria </td></tr>
    <tr><td class="paramname">2</td><td>drop the packet based on mark probability criteria </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a634ddc87ef2123f8966e17b83543a6c5"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int rte_red_enqueue_empty </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *&#160;</td>
          <td class="paramname"><em>red_cfg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structrte__red.html">rte_red</a> *&#160;</td>
          <td class="paramname"><em>red</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint64_t&#160;</td>
          <td class="paramname"><em>time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Updates queue average in condition when queue is empty. </p>
<p>Note: packet is never dropped in this particular case.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">config</td><td>pointer to a RED configuration parameter structure </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">data</td><td>pointer to RED runtime data </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current time stamp</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Operation status </dd></dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>enqueue the packet </td></tr>
    <tr><td class="paramname">1</td><td>drop the packet based on max threshold criterion </td></tr>
    <tr><td class="paramname">2</td><td>drop the packet based on mark probability criterion </td></tr>
  </table>
  </dd>
</dl>
<p>We compute avg but we don't compare avg against min_th or max_th, nor calculate drop probability</p>
<p>m is the number of packets that might have arrived while the queue was empty. In this case we have time stamps provided by scheduler in byte units (bytes transmitted on network port). Such time stamp translates into time units as port speed is fixed but such approach simplifies the code.</p>
<p>Check that m will fit into 16-bit unsigned integer</p>

</div>
</div>
<a class="anchor" id="a5ee559dca02450c40e42fbc6701af465"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int rte_red_enqueue_nonempty </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structrte__red__config.html">rte_red_config</a> *&#160;</td>
          <td class="paramname"><em>red_cfg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structrte__red.html">rte_red</a> *&#160;</td>
          <td class="paramname"><em>red</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned&#160;</td>
          <td class="paramname"><em>q</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Decides if new packet should be enqeued or dropped in queue non-empty case. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">config</td><td>pointer to a RED configuration parameter structure </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">data</td><td>pointer to RED runtime data </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">q</td><td>current queue size (measured in packets)</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Operation status </dd></dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>enqueue the packet </td></tr>
    <tr><td class="paramname">1</td><td>drop the packet based on max threshold criterion </td></tr>
    <tr><td class="paramname">2</td><td>drop the packet based on mark probability criterion </td></tr>
  </table>
  </dd>
</dl>
<p>EWMA filter (Sally Floyd and Van Jacobson): avg = (1 - wq) * avg + wq * q avg = avg + q * wq - avg * wq</p>
<p>We select: wq = 2^(-n). Let scaled version of avg be: avg_s = avg * 2^(N+n). We get: avg_s = avg_s + q * 2^N - avg_s * 2^(-n)</p>
<p>By using shift left/right operations, we get: avg_s = avg_s + (q &lt;&lt; N) - (avg_s &gt;&gt; n) avg_s += (q &lt;&lt; N) - (avg_s &gt;&gt; n)</p>

</div>
</div>
<a class="anchor" id="afa8f3c8188a9863194fab31001225dd6"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void rte_red_mark_queue_empty </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structrte__red.html">rte_red</a> *&#160;</td>
          <td class="paramname"><em>red</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint64_t&#160;</td>
          <td class="paramname"><em>time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Callback to records time that queue became empty. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">data</td><td>pointer to RED runtime data </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current time stamp </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="afcd792387df42bfdf6f73eb13eca9e4a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int rte_red_rt_data_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structrte__red.html">rte_red</a> *&#160;</td>
          <td class="paramname"><em>red</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialises run-time data. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">data</td><td>pointer to RED runtime data</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Operation status </dd></dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>success </td></tr>
    <tr><td class="paramname">!0</td><td>error </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="ae490ddaf8bbddcff7f39643aee34d40e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t rte_red_rand_val</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Externs </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.9.1
</small></address>
</body>
</html>
